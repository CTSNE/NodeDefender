{% extends "base.html" %}
{% block content %}
{% from "nodes/macros/sockets.html" import Lookup, EventListener %}
{{ EventListener(iCPE.macaddr) }}

<script>
namespace = '/nodedata';
var socket = io.connect('//' + document.domain + ':' + location.port + namespace);
</script>

<div class="row">
	<div class="col-lg-12">
		<h1 class="page-header">
			Nodes <small> {{Node.name}} </small>
    </h1>
    <ol class="breadcrumb">
			<li>
				<i class="fa fa-map-marker"></i><a href="{{url_for('index')}}"> Dashboard</a>
			</li>
			<li>
				<a href="{{url_for('NodeView.NodesList')}}"> Node List</a>
			</li>
			<li class="active">{{iCPE.mac}}</li>
    </ol>
  </div>
</div>
{% include "flash.html" %}
{% from "nodes/macros/info.html" import NodeInfo, iCPEInfo, AddiCPE with context %}
{% from "macros/map.html" import Map %}
<div class="row">
	<div class="col-lg-6">
		<div class="panel panel-primary">
			<div class="panel-heading">
				{{ Node.location.street}}, {{ Node.location.city }}
				<div class="floatRight" id="location">
				</div>
			</div>
			<div class="panel-body" style="padding: 0; height: 200px;">
				{{ Map(Node.location.latitude, Node.location.longitude) }}
			</div>
		</div>
	</div>	
	<div class="col-lg-3">
		<div class="panel panel-primary">
			<div class="panel-heading">
				{{Node.name}}
				<div class="floatRight" id="general">
				</div>
			</div>
			<div class="panel-body" style="height: 200px;">
				{{ NodeInfo(Node) }}
			</div>
		</div>
	</div>
	<div class="col-lg-3">
		<div class="panel panel-primary">
			<div class="panel-heading">
				iCPE Connections
				<div class="floatRight" id="iCPEModals">
				</div>
			</div>
			<div class="panel-body" style="height: 200px;">
				{% if Node.icpe %}
				{{ iCPEInfo(iCPE) }}
				{% else %}
				{{ AddiCPE(Node.icpe)}}
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% from "nodes/macros/sensor.html" import SensorBox, SensorScripts %}
{% if Node.icpe.sensors|length > 0 %}
{% for sensors in iCPE.sensors|batch(6) %}
<div class="row">
	{% for sensor in sensors %}
	<div class="col-lg-2">
		<div class="panel panel-info">
			<div class="panel-heading">
				{{ sensor.name }}
				<div class="floatRight">
					<a href="#" style="color: #FFFFFF; margin: 0 5px;" onclick="sensorModal('{{iCPE.macaddr}}', '{{sensor.sensorid}}')"><i class="fa fa-info" aria-hidden="true"></i></a>
				</div>
			</div>
			<div class="panel-body" id="Box{{sensor.sensorid}}">
				{{ SensorBox(sensor) }}
			</div>
		</div>
	</div>
	{% endfor %}
</div>
{% endfor %}
{% endif %}
{% from "macros/statistics.html" import PowerGraph, HeatGraph, EventList with context %}
{% from "macros/data/node/power.html" import Chart as PowerChart %}
{% from "macros/data/node/heat.html" import Chart as HeatChart %}
{% from "macros/data/node/event.html" import EventList %}
<div class="row">
	{% if iCPE.power %}
	<div class="col-lg-4">
		{{ PowerChart(Node) }}
	</div>
	{% endif %}
	{% if iCPE.heat %}
	<div class="col-lg-4">
		{{ HeatChart(Node) }}	
	</div>
	{% endif %}
	{% if iCPE.events %}
	<div class="col-lg-4">
		{{ EventList(Node) }}			
	</div>
	{% endif %}
</div>
{% from "nodes/modals/node.html" import ModalGrouplist, ModifyLocation with context %}
{% from "nodes/modals/node.html" import NodeInformation with context %}
{% from "nodes/modals/icpe.html" import iCPEModal %}
{% from "nodes/modals/sensor.html" import SensorModal %}
<script>
$(document).ready(function() {
icpeMac = "{{iCPE.macaddr}}";
$('#general').prepend('<a style="color: #FFFFFF; margin: 0 5px;" href="#" data-toggle="modal" data-target="#groupList"><i class="fa fa-users" aria-hidden="true"></i></a>');
$('#general').prepend('<a style="color: #FFFFFF; margin: 0 5px;" href="#" data-toggle="modal" data-target="#nodeInfo"><i class="fa fa-info" aria-hidden="true"></i></a>');
$('#iCPEModals').prepend('<a style="color: #FFFFFF; margin: 0 5px;" href="#" onclick="iCPEModal(icpeMac)"><i class="fa fa-info" aria-hidden="true"></i></a>');

{% if current_user.has_role("technician") %}
$('#location').prepend('<a style="color: #FFFFFF; margin: 0 5px;" href="#" data-toggle="modal" data-target="#modifyLocation"><i class="fa fa-pencil" aria-hidden="true"></i></a>');
{% endif %}

});

function sensorModal(iCPE, sensor) {
	sensorSocket.emit('info', {'icpe' : iCPE, 'sensor' : sensor});
	dataSocket.emit('sensorEvents', {'icpe' : iCPE, 'sensor' : sensor});
	
	while (sensorEventTable.rows.length > 0)
		sensorEventTable.deleteRow(0);
	
	$('#SensorModal').modal('show');
}
function iCPEModal(iCPE) {
	iCPESocket.emit('info', {'icpe' : iCPE});
	
	$('#iCPEModal').modal('show');
}


</script>
{{ ModalGrouplist(Node.groups) }}
{{ NodeInformation(Node) }}

{% if current_user.has_role("technician") %}
{{ ModifyLocation(Node.name) }}
{% endif %}
{% if Node.icpe.sensors|length > 0 %}
	{{ SensorScripts(iCPE.sensors) }}
{% endif %}
{{ iCPEModal() }}
{{ SensorModal() }}
{% endblock %}
